<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, shrink-to-fit=no">
    <style>
      html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        margin: 0;
        background-color: #fff;
      }

      #progress {
        position: absolute;
        width: 100%;
        height: 3px;
      }

      #bar {
        background-color: #fff;
        height: 100%;
        transition: width 0.1s ease;
      }

      #bar.hide {
        opacity: 0;
        transition: opacity 1s ease;
      }

      #container {
        width: 100%;
        height: 100%;
        background-color: #000;
      }

      button {
        position: absolute;
        width: 100px;
        height: 30px;
      }

      #btn1 {
        left: 5px;
        top: 5px;
      }

      #btn2 {
        left: 110px;
        top: 5px;
      }

      #btn3 {
        left: 215px;
        top: 5px;
      }

      #btn4 {
        display: none;
        left: 5px;
        bottom: 5px;
      }

      #btn5 {
        display: none;
        left: 110px;
        bottom: 5px;
      }

      /*#desc-container {
        max-width: 500px;
        max-height: 500px;
        min-width: 200px;
        min-height: 250px;
        background: #fff;
        color: #000;
        border-radius: 3px;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }*/

      #desc-container > iframe {
        border: none;
        /*width:100%;*/
      }

      .title {
        display: none;
        font-size: 1.5em;
        text-align: center;
        padding: 5px;
      }

      .text {
        display: none;
        padding: 0 20px 20px 20px;
      }


      #typed {
        color: #fff;
        text-shadow: 0px 0px 2px #000;
        font-size: 24pt;
      }

      #dialog {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        pointer-events: none;
      }

    </style>
  </head>

  <body>

    <div id="progress">
      <div id="bar"></div>
    </div>

    <div id="container"></div>

    <button id="btn1">Panorama1</button>
    <button id="btn2">Panorama2</button>
    <button id="btn3">PanoMoment</button>
    <button id="btn4">Stop Tour</button>
    <button id="btn5">Restart Tour</button>
    
    <div id="desc-container" style="display:none">
      <!-- <iframe src="https://www.youtube.com/embed/D7icsuamx5E"></iframe> -->
      <iframe id="embedPanoMoment" pano="PanoMoments" allowfullscreen="1" allow="gyroscope; accelerometer; xr; vr" frameBorder="0" width="400" height="300" scrolling="no" src="https://my.panomoments.com/embed/5d1d73939546370016d41225?disableLogo=1&disabledQuality=0&disabledInfo=1&disabledFullscreen=0&disabledShuffle=1&disabledShare=1"></iframe>
<!--       <div class="title">PanoMoment within PanoMoment</div>
      <div class="text">Neat</div> -->
    </div>

    <div id="dialog">
      <div id="typed">Welcome. Click the PanoMoment button above to begin your journey.</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/105/three.min.js"></script>
    <script src="../build/panolens.js"></script>
    <script src="typed.js"></script>
    
    <script>

      var panomoment, panorama1, panorama2, viewer, container, embedPanoMomentInfospot;
      
      var identifier = {
        moment_id: "58a5d20affe5e3000bdb34c0",
        variation: 101,
        public_api_key: "63b130be-2f20-40a2-8211-355b607f340a"
      };

      var bar = document.querySelector( '#bar' );

      // Storytelling
      var typed, typed;
      var storyInfospot1, storyInfospot2, storyInfospot3, hiddenInfospot;
      var tweeningDelay = 300, typeStartDelay = 1000, typeSpeed = 50;
      var paragraphs = {

        welcome: [ 'PanoMoments Presents', 'A Journey to <strong>Grand Central</strong>', 'Here we go...' ],
        applestore: [ 'Grand Central is home to an Apple Retail Store', 'while it\'s not historical, it\'s a great place to charge your phone.'],
        vending: [ 'Purchase train tickets here.', 'and also find when your train will arrive.' ],
        ceiling: [ 'A beautiful ceiling mural to stare at.' ],
        ending: [ 'Please continue your journey with Grand Central by clicking and dragging...' ]

      };
      
      // Patch for typed.js of cutting back-to-back words
      for ( var section in paragraphs ) {

        if ( paragraphs.hasOwnProperty( section ) ) {

          paragraphs[ section ].unshift( '' );
          paragraphs[ section ].push( '' );

        }

      }

      function delayExecute ( func, delay ) {

        setTimeout( func, delay );

      }

      function onPanoMomentLoad () {
        type( paragraphs.welcome, onWelcomeComplete, 300 );
        if (typed) {
          viewer.OrbitControls.enabled = false;
        }
      }


      var audioBuffer, buffer, sound;

      function onPanoMomentEnter ( event ) {

        btn4.style.display="block";
        btn5.style.display="block";
        sound.play();
        // progressElement.style.width = 0;
        // progressElement.classList.remove( 'finish' );

      }

      function stopAudio () {
        if (sound) {
          sound.pause();
        }
      }

      function onProgress ( event ) {

        var progress = event.progress.loaded / event.progress.total * 100;
        progressElement.style.width = progress + '%';
        if ( progress === 100 ) {
          progressElement.classList.add( 'finish' );
        }

      }

      function onWelcomeComplete () {

        delayExecute( storyInfospot1.focus.bind( storyInfospot1, 2000 ), tweeningDelay );
        type( paragraphs.applestore, onStory1Complete );
        
      }

      function onStory1Complete () {

        delayExecute( storyInfospot2.focus.bind( storyInfospot2, 2000 ), tweeningDelay );
        type( paragraphs.vending, onStory2Complete );

      }

      function onStory2Complete () {

        delayExecute( storyInfospot3.focus.bind( storyInfospot3, 2000 ), tweeningDelay );
        type( paragraphs.ceiling, onEndComplete );

      }

      function onEndComplete () {
        delayExecute(embedPanoMomentInfospot.focus.bind( embedPanoMomentInfospot, 2000 ), tweeningDelay );
        type( paragraphs.ending, function() { 
          viewer.OrbitControls.enabled = true; 
          embedPanoMomentInfospot.onClick({mouseEvent: {clientX: 0, clientY:0}}) // Bit of a hack to force the hover event
        });
      }

      function type ( stringArray, onComplete, startDelay ) {

        onComplete = onComplete || function(){};
        startDelay = startDelay >= 0 ? startDelay : typeStartDelay;

        typed = new Typed( "#typed", {

          strings: stringArray,
          typeSpeed: typeSpeed,
          showCursor: false,
          startDelay: startDelay,
          onComplete: onComplete
          
        });

      }

      // Infospots
      storyInfospot1 = new PANOLENS.Infospot();
      storyInfospot2 = new PANOLENS.Infospot();
      storyInfospot3 = new PANOLENS.Infospot();
      hiddenInfospot = new PANOLENS.Infospot( 10e-7 );  // Make it not visible

      storyInfospot1.position.set( -187.65, 2110.38, 4518.76 ); // Apple store
      storyInfospot2.position.set( 2645.91, 1095.57, -4087.84 ); // Vending machines
      storyInfospot3.position.set( -2124.13, 4113.43, -1878.20 ); // Ceiling
      hiddenInfospot.position.set( -3461.4, -3592.37, -241.38 );

      storyInfospot1.addHoverText( 'Apple Store', 50 );
      storyInfospot2.addHoverText( 'Ticket Vending', 50 );
      storyInfospot3.addHoverText( 'Ceiling Mural', 50 );

      function onProgressUpdate ( event ) {
        var percentage = event.progress.loaded/ event.progress.total * 100;
        bar.style.width = percentage + "%";
        if (percentage >= 100){
          bar.classList.add( 'hide' );
          setTimeout(function(){
            bar.style.width = 0;
          }, 1000);
        }
      }

      container = document.querySelector( '#container' );

      panorama1 = new PANOLENS.ImagePanorama( 'https://pchen66.github.io/Panolens/examples/asset/textures/equirectangular/tunnel.jpg' );
      panorama1.addEventListener( 'progress', onProgressUpdate );
      panorama1.addEventListener('enter', onStopTour);

      panorama2 = new PANOLENS.ImagePanorama( 'https://pchen66.github.io/Panolens/examples/asset/textures/equirectangular/sunset.jpg' );
      panorama2.addEventListener( 'progress', onProgressUpdate );
      panorama2.addEventListener('enter', onStopTour);

      panomoment = new PANOLENS.PanoMomentPanorama( identifier );
      panomoment.addEventListener( 'progress', onProgressUpdate ); // PanoMomentPanorama doesn't support this yet...

      embedPanoMomentInfospot = new PANOLENS.Infospot();
      embedPanoMomentInfospot.position.set(-227.04, 1937.20, -4596.54);
      embedPanoMomentInfospot.addHoverElement( document.getElementById( 'desc-container' ), 200 );
      panomoment.add( embedPanoMomentInfospot );

      // panomoment.addEventListener( 'progress', onProgress );
      panomoment.addEventListener( 'load', onPanoMomentLoad );
      panomoment.addEventListener( 'enter', onPanoMomentEnter );
      panomoment.add( storyInfospot1, storyInfospot2, storyInfospot3, hiddenInfospot );

      viewer = new PANOLENS.Viewer( { container: container, output: 'console'} );
      viewer.add( panorama1, panorama2, panomoment );
      viewer.setCameraFov(80);

      var listener = new THREE.AudioListener();
      var audioLoader = new THREE.AudioLoader();
      sound = new THREE.Audio( listener );
      audioLoader.load( './asset/audio/grandcentral.mp3', function( buffer ) {
        audioBuffer = buffer;
        sound.setBuffer( buffer );
        sound.setLoop( true );
      });

      var button1 = document.querySelector( '#btn1' );
      var button2 = document.querySelector( '#btn2' );
      var button3 = document.querySelector( '#btn3' );
      var button4 = document.querySelector( '#btn4' );
      var button5 = document.querySelector( '#btn5' );

      // Enter panorama when load completes
      function onButtonClick( targetPanorama ) {
        if (typed) {
          typed.stop(); 
          typed.reset();
          embedPanoMomentInfospot.onDismiss();
          viewer.OrbitControls.enabled = true;
        }
        btn4.style.display="none";
        btn5.style.display="none";
        bar.classList.remove( 'hide' );
        stopAudio();
        viewer.setPanorama( targetPanorama );
      }

      function onPanoMomentButtonClick( targetPanorama ) {
        if (typed) {
          typed.stop(); 
          typed.reset();
          embedPanoMomentInfospot.onDismiss();
          viewer.OrbitControls.enabled = true;
        }
        bar.classList.remove( 'hide' );
        viewer.setPanorama( targetPanorama );
      }

      function onStopTour() {
        if (typed) {
          typed.stop(); 
          typed.reset();
          embedPanoMomentInfospot.onDismiss();
          viewer.OrbitControls.enabled = true;
        }          
        bar.classList.remove( 'hide' );
      }

      function onRestartTour() {
        onStopTour();
        viewer.OrbitControls.enabled = false; 
        type( paragraphs.welcome, onWelcomeComplete, 300 );
      }

      button1.addEventListener( 'click', onButtonClick.bind( this, panorama1 ) );
      button2.addEventListener( 'click', onButtonClick.bind( this, panorama2 ) );
      button3.addEventListener( 'click', onPanoMomentButtonClick.bind( this, panomoment ) );
      button4.addEventListener( 'click', onStopTour.bind( this ) );
      button5.addEventListener( 'click', onRestartTour.bind( this ) );

    </script>

  </body>
</html>